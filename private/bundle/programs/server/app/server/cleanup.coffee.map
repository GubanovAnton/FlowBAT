{"version":3,"sources":["meteor://ðŸ’»app/server/cleanup.coffee"],"names":["Process","Npm","require","share","cleanupQuickQueries","borderline","Date","getTime","day","Queries","find","isQuick","executingInterval","$lte","updatedAt","$lt","forEach","query","remove","_id","cleanupCachedQueryResults","config","Configs","findOne","transform","Transformations","rmCommand","dataTempdir","isSSH","wrapCommand","exec","Meteor","bindEnvironment","err","stdout","stderr","code","error","result","trim","Error","after","userId"],"mappings":"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","file":"/server/cleanup.coffee","sourcesContent":["Process = Npm.require(\"child_process\")\n\nshare.cleanupQuickQueries = ->\n  borderline = new Date(new Date().getTime() - 7 * share.day)\n#  borderline = new Date(new Date().getTime() - 1000)\n  share.Queries.find({isQuick: true, executingInterval: {$lte: 0}, updatedAt: {$lt: borderline}}).forEach (query) ->\n    share.Queries.remove(query._id)\n\nshare.cleanupCachedQueryResults = ->\n  borderline = new Date(new Date().getTime() - 2 * share.day)\n#  borderline = new Date(new Date().getTime() - 1000)\n  config = share.Configs.findOne({}, {transform: share.Transformations.config})\n  share.Queries.find({executingInterval: {$lte: 0}, updatedAt: {$lt: borderline}}).forEach (query) ->\n    rmCommand = \"rm -f \" + config.dataTempdir + \"/\" + query._id + \".rwf\"\n    if config.isSSH\n      rmCommand = config.wrapCommand(rmCommand)\n    Process.exec(rmCommand, Meteor.bindEnvironment((err, stdout, stderr) ->\n      result = stdout.trim()\n      error = stderr.trim()\n      code = if err then err.code else 0\n      if error\n        throw new Error(error)\n    ))\n\nshare.Queries.after.remove (userId, query) ->\n  config = share.Configs.findOne({}, {transform: share.Transformations.config})\n  rmCommand = \"rm -f \" + config.dataTempdir + \"/\" + query._id + \".rwf\"\n  if config.isSSH\n    rmCommand = config.wrapCommand(rmCommand)\n  Process.exec(rmCommand, Meteor.bindEnvironment((err, stdout, stderr) ->\n    result = stdout.trim()\n    error = stderr.trim()\n    code = if err then err.code else 0\n    if error\n      throw new Error(error)\n  ))\n"]}