{"version":3,"sources":["meteor://ðŸ’»app/server/periodic.execution.coffee"],"names":["share","periodicExecution","timeout","nearestExecutingAt","execute","Queries","find","executingAt","$lte","Date","forEach","query","getTime","executingInterval","update","_id","$set","isInputStale","isOutputStale","skipResetTimeout","resetTimeout","nearestQuery","findOne","$ne","sort","Meteor","clearTimeout","Math","max","setTimeout","_","bindAll"],"mappings":";;;;;;;;;AAAAA,MAAMC,iBAAN,GACE;AAAAC,WAAS,IAAT;AACAC,sBAAoB,IADpB;AAEAC,WAAS;AACPJ,UAAMK,OAAN,CAAcC,IAAd,CAAmB;AAACC,mBAAa;AAACC,cAAM,IAAIC,IAAJ;AAAP;AAAd,KAAnB,EAAsDC,OAAtD,CAA8D,UAACC,KAAD;AAE5D,UAAAJ,WAAA,CAF4D,CAM5D;;AAJAA,oBAAc,IAAIE,IAAJ,CAAS,IAAIA,IAAJ,GAAWG,OAAX,KAAuBD,MAAME,iBAAtC,CAAd;AAMA,aALAb,MAAMK,OAAN,CAAcS,MAAd,CAAqBH,MAAMI,GAA3B,EAAgC;AAACC,cAAM;AAACC,wBAAc,IAAf;AAAqBC,yBAAe,IAApC;AAA0CX,uBAAaA;AAAvD;AAAP,OAAhC,EAA6G;AAACY,0BAAkB;AAAnB,OAA7G,CAKA;AARF;AAkBA,WAdA,KAACC,YAAD,EAcA;AArBF;AAQAA,gBAAc;AACZ,QAAAC,YAAA,EAAAnB,OAAA;AAAAmB,mBAAerB,MAAMK,OAAN,CAAciB,OAAd,CAAsB;AAACf,mBAAa;AAACgB,aAAK;AAAN;AAAd,KAAtB,EAAkD;AAACC,YAAM;AAACjB,qBAAa;AAAd;AAAP,KAAlD,CAAf;AACAL,cAAU,KAAK,IAAf;;AACA,QAAGmB,YAAH;AACEnB,gBAAUmB,aAAad,WAAb,CAAyBK,OAAzB,KAAqC,IAAIH,IAAJ,GAAWG,OAAX,EAA/C;AAyBD;;AAxBD,QAAG,KAACV,OAAJ;AACEuB,aAAOC,YAAP,CAAoB,KAACxB,OAArB;AA0BD;;AAzBDA,cAAUyB,KAAKC,GAAL,CAAS,IAAT,EAAe1B,OAAf,CAAV,CAPY,CACZ;AAiCA;;AACA,WA1BA,KAACA,OAAD,GAAWuB,OAAOI,UAAP,CAAkB,KAACzB,OAAnB,EAA4BF,OAA5B,CA0BX;AAnCY;AARd,CADF;;AAoBA4B,EAAEC,OAAF,CAAU/B,MAAMC,iBAAhB,EAAmC,SAAnC,EAA8C,cAA9C,gB","file":"/server/periodic.execution.coffee","sourcesContent":["share.periodicExecution =\n  timeout: null\n  nearestExecutingAt: null\n  execute: ->\n    share.Queries.find({executingAt: {$lte: new Date()}}).forEach (query) ->\n#      cl \"executing\" + query.name + \" at \" + new Date() + \" requested at \" + query.executingAt\n      executingAt = new Date(new Date().getTime() + query.executingInterval)\n      share.Queries.update(query._id, {$set: {isInputStale: true, isOutputStale: true, executingAt: executingAt}}, {skipResetTimeout: true})\n    @resetTimeout()\n  resetTimeout: ->\n    nearestQuery = share.Queries.findOne({executingAt: {$ne: null}}, {sort: {executingAt: 1}})\n    timeout = 30 * 1000\n    if nearestQuery\n      timeout = nearestQuery.executingAt.getTime() - new Date().getTime()\n    if @timeout\n      Meteor.clearTimeout(@timeout)\n    timeout = Math.max(1000, timeout) # at least a second in future; protection from state with executingAt in the past\n#    cl \"resetTimeout to \" + timeout\n    @timeout = Meteor.setTimeout(@execute, timeout)\n\n_.bindAll(share.periodicExecution, \"execute\", \"resetTimeout\")\n"]}