{"version":3,"sources":["meteor://ðŸ’»app/server/methods.coffee"],"names":["share","getMailDomail","matches","process","env","MAIL_URL","match","Meteor","methods","setPassword","userId","password","check","String","Security","hasRole","_debug","Accounts","addNewUser","newUser","config","user","email","Match","App","Email","name","group","InArray","groups","toLowerCase","Configs","findOne","isSetupComplete","createUser","profile","users","update","$set","send","from","root","i18n","t","to","subject","Handlebars","templates","settings","trim","html"],"mappings":";;;;;;;;;AAAAA,MAAMC,aAAN,GAAsB;AACpB,MAAAC,OAAA;;AAAA,MAAGC,QAAQC,GAAR,CAAYC,QAAf;AACEH,cAAUC,QAAQC,GAAR,CAAYC,QAAZ,CAAqBC,KAArB,CAA2B,iCAA3B,CAAV;AACA,WAAOJ,QAAQ,CAAR,CAAP;AAED;;AADD,SAAO,EAAP;AAJoB,CAAtB;;AAMAK,OAAOC,OAAP,CACE;AAAAC,eAAa,UAACC,MAAD,EAASC,QAAT;AACXC,UAAMF,MAAN,EAAcG,MAAd;AACAD,UAAMD,QAAN,EAAgBE,MAAhB;;AACA,UAAOH,WAAU,KAACA,MAAX,IAAqBV,MAAMc,QAAN,CAAeC,OAAf,CAAuB,KAACL,MAAxB,EAAgC,OAAhC,CAA5B;AACEH,aAAOS,MAAP,CAAc,gDAAd;;AACA;AAID;;AACD,WAJAC,SAASR,WAAT,CAAqBC,MAArB,EAA6BC,QAA7B,CAIA;AAVF;AAOAO,cAAY,UAACC,OAAD;AACV,QAAAC,MAAA,EAAAC,IAAA,EAAAX,MAAA;AAAAE,UAAMO,OAAN,EACE;AAAAG,aAAOC,MAAMC,GAAN,CAAUC,KAAjB;AACAC,YAAMb,MADN;AAEAF,gBAAUE,MAFV;AAGAc,aAAOJ,MAAMC,GAAN,CAAUI,OAAV,CAAkB5B,MAAMc,QAAN,CAAee,MAAf,EAAlB;AAHP,KADF;AAKAV,YAAQG,KAAR,GAAgBH,QAAQG,KAAR,CAAcQ,WAAd,EAAhB;;AACA,QAAG,KAACpB,MAAJ;AACE,UAAG,CAAIV,MAAMc,QAAN,CAAeC,OAAf,CAAuB,KAACL,MAAxB,EAAgC,OAAhC,CAAP;AACEH,eAAOS,MAAP,CAAc,8CAAd;;AACA;AAHJ;AAAA;AAKEI,eAASpB,MAAM+B,OAAN,CAAcC,OAAd,EAAT;;AACA,UAAGZ,OAAOa,eAAV;AACE1B,eAAOS,MAAP,CAAc,8CAAd;;AACA;AAFF;AAIEG,gBAAQQ,KAAR,GAAgB,OAAhB;AAVJ;AAoBC;;AATDjB,aAASO,SAASiB,UAAT,CACP;AAAAZ,aAAOH,QAAQG,KAAf;AACAX,gBAAUQ,QAAQR,QADlB;AAEAwB,eACE;AAAAT,cAAMP,QAAQO;AAAd;AAHF,KADO,CAAT;AAKAnB,WAAO6B,KAAP,CAAaC,MAAb,CAAoB3B,MAApB,EAA4B;AAAC4B,YAAM;AAACX,eAAOR,QAAQQ;AAAhB;AAAP,KAA5B;AACAN,WAAOd,OAAO6B,KAAP,CAAaJ,OAAb,CAAqBtB,MAArB,CAAP;AACAe,UAAMc,IAAN,CACE;AAAAC,YAAM,MAAMC,KAAKC,IAAL,CAAUC,CAAV,CAAY,kBAAZ,CAAN,GAAwC,sBAAxC,GAAiE3C,MAAMC,aAAN,EAAjE,GAAyF,GAA/F;AACA2C,UAAIzB,QAAQG,KADZ;AAEAuB,eAASC,WAAWC,SAAX,CAAqB,gBAArB,EAAuC;AAAA1B,cAAMA,IAAN;AAAY2B,kBAAUzC,OAAOyC;AAA7B,OAAvC,EAA8EC,IAA9E,EAFT;AAGAC,YAAMJ,WAAWC,SAAX,CAAqB,aAArB,EAAoC;AAAA1B,cAAMA,IAAN;AAAYC,eAAOH,QAAQG,KAA3B;AAAkCX,kBAAUQ,QAAQR,QAApD;AAA8DqC,kBAAUzC,OAAOyC;AAA/E,OAApC,EAA6HC,IAA7H;AAHN,KADF;AA8BA,WAzBAvC,MAyBA;AAvDU;AAPZ,CADF,0E","file":"/server/methods.coffee","sourcesContent":["share.getMailDomail = ->\n  if process.env.MAIL_URL\n    matches = process.env.MAIL_URL.match(/\\/\\/(.+)%40(.+):(.+)@(.+):(\\d+)/)\n    return matches[2]\n  return \"\"\n\nMeteor.methods\n  setPassword: (userId, password) ->\n    check(userId, String)\n    check(password, String)\n    unless userId is @userId or share.Security.hasRole(@userId, \"admin\")\n      Meteor._debug(\"Setting password is not allowed for non admins\")\n      return\n    Accounts.setPassword(userId, password)\n  addNewUser: (newUser) ->\n    check newUser,\n      email: Match.App.Email\n      name: String\n      password: String\n      group: Match.App.InArray(share.Security.groups())\n    newUser.email = newUser.email.toLowerCase()\n    if @userId\n      if not share.Security.hasRole(@userId, \"admin\")\n        Meteor._debug(\"Creating users is not allowed for non admins\")\n        return\n    else\n      config = share.Configs.findOne()\n      if config.isSetupComplete\n        Meteor._debug(\"Creating users is not allowed for non admins\")\n        return\n      else\n        newUser.group = \"admin\"\n    userId = Accounts.createUser\n      email: newUser.email\n      password: newUser.password\n      profile:\n        name: newUser.name\n    Meteor.users.update(userId, {$set: {group: newUser.group}})\n    user = Meteor.users.findOne(userId)\n    Email.send\n      from: '\"' + root.i18n.t(\"messages.postman\") + ' (FlowBAT)\" <herald@' + share.getMailDomail() + '>'\n      to: newUser.email\n      subject: Handlebars.templates[\"newUserSubject\"](user: user, settings: Meteor.settings).trim()\n      html: Handlebars.templates[\"newUserHtml\"](user: user, email: newUser.email, password: newUser.password, settings: Meteor.settings).trim()\n    userId\n"]}