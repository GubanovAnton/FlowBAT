{"version":3,"sources":["meteor://ðŸ’»app/server/execution.coffee"],"names":["Future","Process","executeQuery","fs","loadQueryResult","writeFile","Npm","require","wrap","share","Queries","after","update","userId","query","fieldNames","modifier","options","_","intersection","inputFields","length","_id","$set","isInputStale","callback","config","profile","isOutputStale","Configs","findOne","transform","Transformations","inputOptions","Meteor","users","ownerId","result","error","code","methods","checkConnection","fut","queryId","Match","Error","insert","interface","cmd","isQuick","unblock","throw","return","wait","loadDataForCSV","check","App","QueryId","startRecNum","numRecs","getRwfToken","token","Random","id","copyCommand","isSSH","getSSHOptions","port","user","host","dataTempdir","exec","bindEnvironment","err","stdout","stderr","trim","command","isIpsetStale","isTupleStale","rwsetbuildErrors","rwsetbuildFutures","tuplebuildErrors","tuplebuildFutures","each","field","rmCommand","rmFuture","rwsFilename","rwsetbuildFuture","scpCommand","scpFuture","set","txtFilename","writeFileFuture","IPSets","contents","push","wrapCommand","resolve","rwsetbuildCommand","join","tupleFilename","tuplebuildFuture","Tuples","tuplebuildCommand","inputCommand","indexOf","outputCommand"],"mappings":"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","file":"/server/execution.coffee","sourcesContent":["fs = Npm.require(\"fs\")\nProcess = Npm.require(\"child_process\")\nFuture = Npm.require('fibers/future')\nwriteFile = Future.wrap(fs.writeFile)\n\nshare.Queries.after.update (userId, query, fieldNames, modifier, options) ->\n  if _.intersection(fieldNames, share.inputFields).length\n    share.Queries.update(query._id, {$set: {isInputStale: true}})\n\nshare.Queries.after.update (userId, query, fieldNames, modifier, options) ->\n  if not query.isOutputStale\n    return\n  config = share.Configs.findOne({}, {transform: share.Transformations.config})\n  query = share.Transformations.query(query)\n  if not query.inputOptions(config)\n    share.Queries.update(query._id, {$set: {isInputStale: false, isOutputStale: false}})\n    return\n  profile = Meteor.users.findOne(query.ownerId).profile\n  callback = (result, error, code) ->\n    share.Queries.update(query._id, {$set: {result: result, error: error, code: code, isInputStale: false, isOutputStale: false}})\n  loadQueryResult(query, config, profile, callback)\n\nMeteor.methods\n  checkConnection: ->\n    unless @userId\n      throw new Match.Error(\"Operation not allowed for unauthorized users\")\n    queryId = share.Queries.insert({\n      interface: \"cmd\"\n      cmd: \"--protocol=0-255\"\n      isQuick: true\n    })\n    config = share.Configs.findOne({}, {transform: share.Transformations.config})\n    profile = Meteor.users.findOne(@userId).profile\n    query = share.Queries.findOne(queryId, {transform: share.Transformations.query})\n    @unblock()\n    fut = new Future()\n    callback = (result, error, code) ->\n      if error\n        fut.throw(new Meteor.Error(500, error))\n      else\n        fut.return(result)\n    executeQuery(query, config, profile, callback)\n    fut.wait()\n    # quick queries are cleaned up automatically\n  loadDataForCSV: (queryId) ->\n    check(queryId, Match.App.QueryId)\n    unless @userId\n      throw new Match.Error(\"Operation not allowed for unauthorized users\")\n    config = share.Configs.findOne({}, {transform: share.Transformations.config})\n    query = share.Queries.findOne(queryId, {transform: share.Transformations.query})\n    unless @userId is query.ownerId\n      throw new Match.Error(\"Operation not allowed for non-owners\")\n    @unblock()\n    fut = new Future()\n    callback = (result, error, code) ->\n      if error\n        fut.throw(new Error(error))\n      else\n        fut.return(result)\n    query.startRecNum = 1\n    loadQueryResult(query, config, {numRecs: 0}, callback)\n    fut.wait()\n  getRwfToken: (queryId) ->\n    check(queryId, Match.App.QueryId)\n    unless @userId\n      throw new Match.Error(\"Operation not allowed for unauthorized users\")\n    config = share.Configs.findOne({}, {transform: share.Transformations.config})\n    profile = Meteor.users.findOne(@userId).profile\n    query = share.Queries.findOne(queryId, {transform: share.Transformations.query})\n    unless @userId is query.ownerId\n      throw new Match.Error(\"Operation not allowed for non-owners\")\n    @unblock()\n    token = Random.id()\n    fut = new Future()\n    callback = (result, error, code) ->\n      if error\n        fut.throw(new Error(error))\n      else\n        if config.isSSH\n          copyCommand = \"scp \" + config.getSSHOptions() + \" -P \" + config.port + \" \" + config.user + \"@\" + config.host + \":\" + config.dataTempdir + \"/\" + query._id + \".rwf \" + \"/tmp\" + \"/\" + token + \".rwf\"\n        else\n          copyCommand = \"cp \" + config.dataTempdir + \"/\" + query._id + \".rwf \" + \"/tmp\" + \"/\" + token + \".rwf\"\n        Process.exec(copyCommand, Meteor.bindEnvironment((err, stdout, stderr) ->\n          result = stdout.trim()\n          error = stderr.trim()\n          code = if err then err.code else 0\n          if error\n            fut.throw(new Error(error))\n          else\n            fut.return(token)\n        ))\n    executeQuery(query, config, profile, callback)\n    fut.wait()\n\nexecuteQuery = (query, config, profile, callback) ->\n  rwsetbuildErrors = []\n  rwsetbuildFutures = []\n  isIpsetStale = false\n  _.each([\"dipSet\", \"sipSet\", \"anySet\"], (field) ->\n    if query[field + \"Enabled\"] and query[field]\n      set = share.IPSets.findOne(query[field])\n      if set.isOutputStale\n        isIpsetStale = true\n        rwsetbuildFuture = new Future()\n        txtFilename = \"/tmp\" + \"/\" + set._id + \".txt\"\n        rwsFilename = config.dataTempdir + \"/\" + set._id + \".rws\"\n        writeFileFuture = writeFile(txtFilename, set.contents)\n        if config.isSSH\n          scpCommand = \"scp \" + config.getSSHOptions() + \" -P \" + config.port + \" \" + txtFilename + \" \" + config.user + \"@\" + config.host + \":\" + txtFilename\n          scpFuture = new Future()\n          Process.exec(scpCommand, Meteor.bindEnvironment((err, stdout, stderr) ->\n            result = stdout.trim()\n            error = stderr.trim()\n            code = if err then err.code else 0\n            if error\n              rwsetbuildErrors.push(error)\n            if code is 0\n            else\n              if not error\n                throw \"scp: code is \\\"\" + code + \"\\\" while stderr is \\\"\" + error + \"\\\"\"\n            scpFuture.return(result)\n          ))\n          scpFuture.wait()\n        rmCommand = \"rm -f \" + rwsFilename\n        if config.isSSH\n          rmCommand = config.wrapCommand(rmCommand)\n        rmFuture = new Future()\n        Process.exec(rmCommand, Meteor.bindEnvironment((err, stdout, stderr) ->\n          result = stdout.trim()\n          error = stderr.trim()\n          code = if err then err.code else 0\n          if error\n            rwsetbuildErrors.push(error)\n          if code is 0\n          else\n            if not error\n              throw \"rm: code is \\\"\" + code + \"\\\" while stderr is \\\"\" + error + \"\\\"\"\n          rmFuture.return(result)\n        ))\n        rmFuture.wait()\n        writeFileFuture.resolve Meteor.bindEnvironment((err, result) ->\n          if err\n            rwsetbuildErrors.push(err)\n            rwsetbuildFuture.return(result)\n          else\n            rwsetbuildCommand = \"rwsetbuild \" + txtFilename + \" \" + rwsFilename\n            if config.isSSH\n              rwsetbuildCommand = config.wrapCommand(rwsetbuildCommand)\n            Process.exec(rwsetbuildCommand, Meteor.bindEnvironment((err, stdout, stderr) ->\n              result = stdout.trim()\n              error = stderr.trim()\n              code = if err then err.code else 0\n              if error\n                rwsetbuildErrors.push(error)\n              if code is 0\n                share.IPSets.update(set._id, {$set: {isOutputStale: false}})\n              else\n                if not error\n                  throw \"rwsetbuild: code is \\\"\" + code + \"\\\" while stderr is \\\"\" + error + \"\\\"\"\n              rwsetbuildFuture.return(result)\n            ))\n        )\n        rwsetbuildFutures.push(rwsetbuildFuture)\n  )\n  Future.wait(rwsetbuildFutures)\n\n  if rwsetbuildErrors.length\n    callback(\"\", rwsetbuildErrors.join(\"\\n\"), 255)\n    return\n\n  if not query.isInputStale and not isIpsetStale\n    callback(\"\", \"\", 0)\n    return\n\n  tuplebuildErrors = []\n  tuplebuildFutures = []\n  isTupleStale = false\n  _.each([\"tupleFile\"], (field) ->\n    if query[field + \"Enabled\"] and query[field]\n      set = share.Tuples.findOne(query[field])\n      if set.isOutputStale\n        isTupleStale = true\n        tuplebuildFuture = new Future()\n        txtFilename = \"/tmp\" + \"/\" + set._id + \".txt\"\n        tupleFilename = config.dataTempdir + \"/\" + set._id + \".tuple\"\n        writeFileFuture = writeFile(txtFilename, set.contents)\n        if config.isSSH\n          scpCommand = \"scp \" + config.getSSHOptions() + \" -P \" + config.port + \" \" + txtFilename + \" \" + config.user + \"@\" + config.host + \":\" + txtFilename\n          scpFuture = new Future()\n          Process.exec(scpCommand, Meteor.bindEnvironment((err, stdout, stderr) ->\n            result = stdout.trim()\n            error = stderr.trim()\n            code = if err then err.code else 0\n            if error\n              tuplebuildErrors.push(error)\n            if code is 0\n            else\n              if not error\n                throw \"scp: code is \\\"\" + code + \"\\\" while stderr is \\\"\" + error + \"\\\"\"\n            scpFuture.return(result)\n          ))\n          scpFuture.wait()\n        rmCommand = \"rm -f \" + tupleFilename\n        if config.isSSH\n          rmCommand = config.wrapCommand(rmCommand)\n        rmFuture = new Future()\n        Process.exec(rmCommand, Meteor.bindEnvironment((err, stdout, stderr) ->\n          result = stdout.trim()\n          error = stderr.trim()\n          code = if err then err.code else 0\n          if error\n            tuplebuildErrors.push(error)\n          if code is 0\n          else\n            if not error\n              throw \"rm: code is \\\"\" + code + \"\\\" while stderr is \\\"\" + error + \"\\\"\"\n          rmFuture.return(result)\n        ))\n        rmFuture.wait()\n        writeFileFuture.resolve Meteor.bindEnvironment((err, result) ->\n          if err\n            tuplebuildErrors.push(err)\n            tuplebuildFuture.return(result)\n          else\n            tuplebuildCommand = \"cat \" + txtFilename + \" > \" + tupleFilename\n            if config.isSSH\n              tuplebuildCommand = config.wrapCommand(tuplebuildCommand)\n            Process.exec(tuplebuildCommand, Meteor.bindEnvironment((err, stdout, stderr) ->\n              result = stdout.trim()\n              error = stderr.trim()\n              code = if err then err.code else 0\n              if error\n                tuplebuildErrors.push(error)\n              if code is 0\n                share.Tuples.update(set._id, {$set: {isOutputStale: false}})\n              else\n                if not error\n                  throw \"tuplebuild: code is \\\"\" + code + \"\\\" while stderr is \\\"\" + error + \"\\\"\"\n              tuplebuildFuture.return(result)\n            ))\n        )\n        tuplebuildFutures.push(tuplebuildFuture)\n  )\n  Future.wait(tuplebuildFutures)\n\n  if tuplebuildErrors.length\n    callback(\"\", tuplebuildErrors.join(\"\\n\"), 255)\n    return\n\n  if not query.isInputStale and not isTupleStale\n    callback(\"\", \"\", 0)\n    return\n\n  command = query.inputCommand(config, profile)\n  Process.exec(command, Meteor.bindEnvironment((err, stdout, stderr) ->\n    result = stdout.trim()\n    error = stderr.trim()\n    code = if err then err.code else 0\n    if error.indexOf(\"Rejected\") isnt -1\n      error = null\n    callback(result, error, code)\n  ))\n\nloadQueryResult = (query, config, profile, callback) ->\n  executeQuery(query, config, profile, Meteor.bindEnvironment((result, error, code) ->\n    if error\n      return callback(result, error, code)\n    command = query.outputCommand(config, profile)\n    Process.exec(command, Meteor.bindEnvironment((err, stdout, stderr) ->\n      result = stdout.trim()\n      error = stderr.trim()\n      code = if err then err.code else 0\n      if error.indexOf(\"Error opening file\") isnt -1\n        query.isInputStale = true\n        loadQueryResult(query, config, profile, callback)\n      else\n        callback(result, error, code)\n    ))\n  ))\n"]}